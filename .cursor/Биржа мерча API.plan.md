<!-- 04118b15-61b4-4163-b06d-b2a164b74ee9 ee9b8c8e-a539-4cdb-a3ba-5bf5956f7dfd -->
# Биржа раритетного мерча на Go

## Общая концепция

Платформа для торговли редким коллекционным мерчем (винтажная одежда, лимитированные кроссовки, коллекционные игрушки, постеры и т.д.) с тремя основными механиками:

1. **Аукционы** - продажа через систему ставок с динамическим продлением
2. **Лотереи** - розыгрыш права на покупку редких вещей
3. **Конкурсы** - соревнования коллекционеров за уникальные лоты

## Архитектура приложения

### Технологический стек

- **Framework**: Gin или Echo для REST API
- **База данных**: PostgreSQL (основная) + Redis (кэш/очереди)
- **Документация**: Swagger/OpenAPI (swaggo/swag)
- **Миграции**: golang-migrate
- **Конфигурация**: viper
- **Логирование**: zap или zerolog
- **Валидация**: go-playground/validator

### Структура проекта (чистая архитектура)

```
rare-merch-exchange/
├── cmd/
│   └── api/
│       └── main.go                 # Точка входа
├── internal/
│   ├── domain/                     # Бизнес-логика и сущности
│   │   ├── item/                   # Товары
│   │   ├── auction/                # Аукционы
│   │   ├── lottery/                # Лотереи
│   │   ├── contest/                # Конкурсы
│   │   ├── user/                   # Пользователи
│   │   ├── transaction/            # Транзакции и escrow
│   │   └── verification/           # Верификация товаров
│   ├── usecase/                    # Бизнес-логика
│   ├── delivery/                   # HTTP handlers
│   │   └── http/
│   │       └── v1/
│   ├── repository/                 # Работа с БД
│   └── pkg/                        # Утилиты
│       ├── auth/                   # JWT аутентификация
│       ├── antifraud/              # Антифрод система
│       └── pricing/                # Динамическое ценообразование
├── migrations/
├── docs/                           # Swagger документация
└── config/
```

## Ключевые компоненты и бизнес-логика

### 1. Система аукционов

**Интересная механика:**

- **Мягкое закрытие (Soft Close)**: если ставка делается в последние 5 минут, аукцион продлевается на 5 минут
- **Инкрементальные ставки**: минимальный шаг зависит от текущей цены (1-100$ -> +5$, 100-1000$ -> +25$)
- **Резервная цена**: скрытая минимальная цена, до достижения которой лот не продаётся
- **Автоматические ставки**: пользователи устанавливают максимальную сумму, система автоматически перебивает других
- **Депозитная система**: для участия нужно заморозить 10% от стартовой цены

**Основные операции:**

- Создание аукциона (только верифицированные продавцы)
- Размещение ставки с валидацией
- Автоматическое завершение через cron/scheduler
- Обработка победителя и создание escrow-транзакции

### 2. Система лотерей

**Механики розыгрышей:**

- **Лотерея с равными шансами**: каждый билет даёт равный шанс
- **Weighted lottery**: чем больше активности пользователя, тем выше шанс
- **Instant win**: часть билетов выигрывают моментально
- **Джекпот-лотереи**: если никто не выиграл, фонд переходит на следующий розыгрыш

**Антифрод:**

- Ограничение билетов на пользователя
- Верификация уникальности (KYC light)
- Детекция ботов по паттернам покупок
- Provably fair алгоритм розыгрыша (криптографическая проверяемость)

**Алгоритм честного розыгрыша:**

```
1. При создании лотереи генерируется server_seed (хешируется и публикуется)
2. При закрытии используются: server_seed + client_seeds всех участников + block_hash последнего блока блокчейна
3. Результат: SHA256(server_seed + client_seeds + block_hash) % total_tickets
```

### 3. Система конкурсов

**Типы конкурсов:**

- **Коллекционные сеты**: собери полный набор предметов определённой серии
- **Фото-конкурсы**: покажи свою коллекцию, голосование сообщества
- **Квизы**: ответь на вопросы о редком мерче
- **Speed-конкурсы**: первые N человек, выполнившие задание

**Система рейтинга:**

- Очки за участие, победы, активность
- Ранги: Новичок → Коллекционер → Эксперт → Легенда
- Бонусы высоких рангов: приоритет в лотереях, скидки на комиссию

### 4. Система верификации товаров

**Процесс верификации:**

- Загрузка фото со всех ракурсов
- Ручная проверка экспертами для дорогих лотов (>$500)
- Присвоение рейтинга подлинности: A (гарантированный оригинал), B (скорее оригинал), C (требует проверки)

**Штрафы за подделки:**

- Блокировка аккаунта
- Чёрный список
- Возврат средств покупателям

### 5. Escrow-система

**Механизм безопасных сделок:**

1. Победитель аукциона/лотереи блокирует полную сумму в escrow
2. Продавец отправляет товар (вносит трек-номер)
3. Покупатель получает товар и подтверждает в течение 7 дней
4. Средства переводятся продавцу за вычетом комиссии (5-10%)
5. При споре - арбитраж платформы (review фото, переписки)

**Автоматизация:**

- Интеграция с API служб доставки для отслеживания
- Автоматический релиз средств при доставке + 3 дня без жалоб
- Система уведомлений на каждом этапе

### 6. Антифрод система

**Детекция подозрительной активности:**

- **Shill bidding**: продавец накручивает цену через подставных лиц
  - Алгоритм: анализ IP, паттернов ставок, связей между аккаунтами
- **Wash trading**: фиктивные сделки для накрутки рейтинга
  - Граф связей между пользователями
- **Bot detection**: массовая регистрация на лотереи
  - Rate limiting, CAPTCHA, анализ поведения
- **Price manipulation**: согласованные действия для влияния на цену
  - Мониторинг аномальных ценовых паттернов

### 7. Динамическое ценообразование

**Рекомендуемая цена для продавцов:**

- Анализ истории продаж аналогичных товаров
- Учёт состояния (новое/б/у), редкости, трендов
- ML-модель для предсказания финальной цены аукциона

**Комиссии:**

- Базовая: 5% для верифицированных, 8% для обычных
- Динамическая: снижается при высоком рейтинге продавца
- Премиум-размещение: за дополнительную плату лот на главной странице

## Основные API endpoints

### Аукционы

```
POST   /api/v1/auctions              # Создать аукцион
GET    /api/v1/auctions              # Список активных аукционов (фильтры, пагинация)
GET    /api/v1/auctions/:id          # Детали аукциона
POST   /api/v1/auctions/:id/bid      # Сделать ставку
GET    /api/v1/auctions/:id/bids     # История ставок
POST   /api/v1/auctions/:id/autobid  # Установить автоставку
```

### Лотереи

```
POST   /api/v1/lotteries             # Создать лотерею
GET    /api/v1/lotteries             # Список лотерей
GET    /api/v1/lotteries/:id         # Детали лотереи
POST   /api/v1/lotteries/:id/tickets # Купить билеты
GET    /api/v1/lotteries/:id/verify  # Проверить честность розыгрыша
```

### Конкурсы

```
POST   /api/v1/contests              # Создать конкурс
GET    /api/v1/contests              # Список конкурсов
POST   /api/v1/contests/:id/submit   # Отправить участие
POST   /api/v1/contests/:id/vote     # Проголосовать (для фото-конкурсов)
GET    /api/v1/contests/:id/results  # Результаты
```

### Товары и верификация

```
POST   /api/v1/items                 # Добавить товар
GET    /api/v1/items/:id             # Детали товара
POST   /api/v1/items/:id/verify      # Отправить на верификацию
GET    /api/v1/items/:id/authenticity # Статус подлинности
```

### Транзакции

```
GET    /api/v1/transactions          # История транзакций
GET    /api/v1/transactions/:id      # Детали транзакции
POST   /api/v1/transactions/:id/confirm # Подтвердить получение
POST   /api/v1/transactions/:id/dispute # Открыть спор
```

### Пользователи

```
POST   /api/v1/auth/register         # Регистрация
POST   /api/v1/auth/login            # Вход
GET    /api/v1/users/me              # Профиль
GET    /api/v1/users/:id             # Публичный профиль
GET    /api/v1/users/:id/rating      # Рейтинг и достижения
```

## База данных

### Основные таблицы

**users**: id, email, password_hash, rating, rank, verified, kyc_status, created_at

**items**: id, seller_id, title, description, category, condition, photos, verification_status, authenticity_grade

**auctions**: id, item_id, start_price, reserve_price, current_price, start_time, end_time, status, soft_close_enabled

**bids**: id, auction_id, user_id, amount, auto_bid_max, timestamp

**lotteries**: id, item_id, ticket_price, max_tickets, tickets_sold, draw_time, winner_id, server_seed, result_proof

**lottery_tickets**: id, lottery_id, user_id, ticket_numbers, client_seed

**contests**: id, type, prize_item_id, start_time, end_time, rules

**contest_submissions**: id, contest_id, user_id, content, votes, ranking

**transactions**: id, buyer_id, seller_id, item_id, amount, status, escrow_released, tracking_number

**fraud_alerts**: id, user_id, type, severity, description, reviewed

### Индексы для производительности

- auctions(status, end_time) - для выборки активных
- bids(auction_id, timestamp) - история ставок
- items(category, verification_status) - фильтрация
- lottery_tickets(lottery_id, user_id) - подсчёт билетов
- transactions(status, created_at) - мониторинг

## Фоновые задачи (Workers)

1. **Auction Finalizer**: каждую минуту проверяет завершённые аукционы, определяет победителя
2. **Lottery Drawer**: в момент окончания лотереи проводит розыгрыш
3. **Escrow Monitor**: отслеживает статусы доставки, автоматически релизит средства
4. **Fraud Detector**: анализирует активность на аномалии
5. **Notification Service**: отправка email/push уведомлений
6. **Price Analyzer**: обновление рекомендованных цен на основе истории

## Swagger документация

Использование `swaggo/swag`:

```go
// @title Rare Merch Exchange API
// @version 1.0
// @description API для биржи раритетного мерча с аукционами, лотереями и конкурсами
// @host localhost:8080
// @BasePath /api/v1
// @securityDefinitions.apikey BearerAuth
// @in header
// @name Authorization

// В каждом handler комментарии:
// @Summary Создать аукцион
// @Tags auctions
// @Accept json
// @Produce json
// @Param auction body CreateAuctionRequest true "Данные аукциона"
// @Success 201 {object} AuctionResponse
// @Failure 400 {object} ErrorResponse
// @Security BearerAuth
// @Router /auctions [post]
```

Генерация: `swag init -g cmd/api/main.go`

Доступ к UI: `http://localhost:8080/swagger/index.html`

## Интересные технические решения

### 1. Оптимистичные блокировки для ставок

Использование PostgreSQL row-level locks для предотвращения race conditions при одновременных ставках:

```go
// В транзакции
row := tx.QueryRow(`
    UPDATE auctions 
    SET current_price = $1, updated_at = NOW() 
    WHERE id = $2 AND current_price < $1
    RETURNING id
`, newBid, auctionID)
```

### 2. Redis для real-time обновлений

- Pub/Sub для уведомления клиентов о новых ставках
- Sorted Sets для лидербордов конкурсов
- TTL кэш для популярных лотов

### 3. Event Sourcing для аудита

Все критичные действия (ставки, покупки билетов) сохраняются как события для возможности восстановления и анализа.

### 4. Graceful shutdown

Корректное завершение обработки запросов и фоновых задач при остановке сервиса.

## Метрики и мониторинг

- **Prometheus**: метрики производительности, бизнес-метрики (GMV, конверсия)
- **Grafana**: дашборды для визуализации
- **Sentry**: отслеживание ошибок
- **ELK**: централизованное логирование

## Развитие функциональности

**Фаза 2 (Мобильные улучшения):**

- WebSocket для real-time обновлений в приложении
- Социальные функции (подписки на коллекционеров, лента активности)
- AR-функции для проверки подлинности товаров
- Интеграция с Apple Pay/Google Pay

**Фаза 3 (Расширенная функциональность):**

- NFT-сертификаты подлинности
- Страхование дорогих лотов
- Международная доставка с партнёрами
- API для сторонних продавцов
- Мультиязычность в мобильном приложении

## Оценка сложности

- **Разработка MVP**: 8-10 недель (1-2 разработчика)
- **Основные компоненты**: 12-15
- **Строк кода**: ~20-25k LOC
- **API endpoints**: ~60-70 (включая мобильные и web)

### To-dos

- [ ] Настройка структуры проекта Go с чистой архитектурой и зависимостями
- [ ] Создание схемы БД PostgreSQL с миграциями для всех сущностей (включая мобильные таблицы)
- [ ] Настройка Redis для кэширования и push-уведомлений
- [ ] Интеграция Firebase Cloud Messaging для push-уведомлений
- [ ] Настройка S3/MinIO для хранения изображений товаров
- [ ] Реализация domain-моделей: Item, Auction, Lottery, Contest, User, Transaction, Notification
- [ ] Бизнес-логика аукционов: ставки, soft close, автоставки, депозиты
- [ ] Механика лотерей: покупка билетов, provably fair розыгрыш, weighted lottery
- [ ] Система конкурсов: разные типы, голосование, рейтинг участников
- [ ] Escrow-транзакции: блокировка средств, арбитраж, автоматический релиз
- [ ] Система верификации товаров: загрузка фото, присвоение грейда подлинности
- [ ] Антифрод: детекция shill bidding, bot detection, анализ паттернов
- [ ] API аутентификации: регистрация, логин, JWT токены, FCM токены
- [ ] Мобильные API для аукционов: оптимизированные списки, быстрые ставки, подписки
- [ ] Мобильные API для лотерей: покупка билетов, проверка честности, история выигрышей
- [ ] Мобильные API для конкурсов: участие, голосование, результаты
- [ ] API для товаров: загрузка фото, поиск, категории
- [ ] API для транзакций: история, подтверждения, споры
- [ ] API для уведомлений: список, статус прочтения
- [ ] API для офлайн-синхронизации
- [ ] Web API для создания аукционов, лотерей, конкурсов
- [ ] Web API для верификации товаров
- [ ] Web API для антифрод мониторинга
- [ ] Фоновые задачи: завершение аукционов, розыгрыш лотерей, мониторинг escrow
- [ ] Push-уведомления через FCM
- [ ] Обработка изображений: сжатие, миниатюры, WebP конвертация
- [ ] Rate limiting для защиты от спама
- [ ] Кэширование популярных данных в Redis
- [ ] Подготовка данных для офлайн-режима
- [ ] Интеграция Swagger документации для всех API endpoints (мобильных и web)
- [ ] Настройка метрик и мониторинга (Prometheus, Grafana)
- [ ] Логирование и отслеживание ошибок (Sentry, ELK)